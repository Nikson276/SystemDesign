@startuml
title Единый поток аутентификации (Соцсети + Email/Пароль)

actor User as U
participant "Frontend" as FE
participant "Auth Service" as AS
participant "OAuth Provider\n(Google/VK/Yandex)" as OP
participant "Users Service" as US

== Вход через соцсеть (OIDC) ==
U -> FE: Нажимает "Войти через соцсеть"
FE -> AS: Запрос на авторизацию через выбранного провайдера
AS -> OP: Перенаправление (OIDC Authorization Request)
OP -> U: Форма авторизации
U -> OP: Ввод данных и подтверждение
OP -> FE: Authorization Code (редирект)
FE -> AS: Передача Authorization Code
AS -> OP: Обмен Code на Access Token + ID Token
OP -> AS: Токены + профиль (OIDC UserInfo)
AS -> US: Create/Update пользователя с данными профиля
US -> AS: Возвращает internal user_id

== Вход по Email/Пароль ==
U -> FE: Ввод email и пароль
FE -> AS: Запрос логина (email, password)
AS -> US: Запрос пользователя по email
US -> AS: Возвращает профиль и password_hash
AS -> AS: Проверка пароля (bcrypt/scrypt/argon2)
AS -> US: Получение is_premium, region, plan_type

== Общий этап генерации JWT ==
AS -> FE: Выдача JWT (user_id_internal, is_premium, plan_type, region)
note right of AS: JWT — единый формат для всех способов входа. В системе используется внутренний user_id.
@enduml