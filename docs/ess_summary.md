
## üìå –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

‚úÖ **–ù–∞–≥—Ä—É–∑–∫–∞**:

- **1‚ÄØ952‚ÄØ643** —Å–æ–±—ã—Ç–∏–π –∑–∞ **3m30s**  
- **9‚ÄØ282 RPS** (—É—Å–ø–µ—à–Ω–æ, 100% success rate)  
- **HTTP p95 latency**: **418 –º—Å**

‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ClickHouse**:

- **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**: 1‚ÄØ952‚ÄØ643 –∑–∞–ø–∏—Å–µ–π ‚Üí 1‚ÄØ952‚ÄØ643 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö `id`  
- **–î—É–±–ª–∏–∫–∞—Ç–æ–≤: 0**  
- **e2e latency (ingest ‚Üí store)**: **~476 —Å–µ–∫ (–º–µ–¥–∏–∞–Ω–∞)**  
  > ‚ö†Ô∏è *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≤—ã—Å–æ–∫–∏–π e2e —Å–≤—è–∑–∞–Ω —Å —Ç–µ–º, —á—Ç–æ consumer'—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –æ—á–µ—Ä–µ–¥—å **–ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞** ‚Äî –Ω–æ —Å–∞–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞.*

‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:

- **4 –Ω–æ–¥—ã ClickHouse**: 2 —à–∞—Ä–¥–∞ √ó 2 —Ä–µ–ø–ª–∏–∫–∏  
- **4 consumer'–∞** –≤ Kafka consumer group  
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞** —á–µ—Ä–µ–∑ `aiochclient` + –±–∞—Ç—á–∏–Ω–≥  
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**: `ReplacingMergeTree` + –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏

---

## üß≠ –≠–≤–æ–ª—é—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: –æ—Ç v1 –∫ production

| –≠—Ç–∞–ø | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|------|-------------|---------|--------|----------|
| **v1**<br>_–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π consumer_ | FastAPI ‚Üí Kafka ‚Üí **–æ–¥–∏–Ω consumer** —Å `clickhouse-driver`<br>–ó–∞–ø–∏—Å—å –ø–æ –æ–¥–Ω–æ–º—É —Å–æ–±—ã—Ç–∏—é | ‚Ä¢ **–°–∏–ª—å–Ω–µ–π—à–∏–π –ª–∞–≥** (33+ –º–∏–Ω)<br>‚Ä¢ **Consumer –Ω–µ —Å–ø—Ä–∞–≤–ª—è–ª—Å—è —Å 1.2K RPS**<br>‚Ä¢ –ü–∞–¥–µ–Ω–∏—è –∏–∑-–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ event loop | ‚Äî | –ù–µ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ |
| **v2**<br>_–ë–∞—Ç—á–∏–Ω–≥ –≤ –ø–∞–º—è—Ç–∏_ | Consumer –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è ‚Üí –±–∞—Ç—á-–≤—Å—Ç–∞–≤–∫–∞ –≤ ClickHouse | ‚Ä¢ **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥ Kafka**<br>‚Ä¢ Consumer –Ω–µ —É–∫–ª–∞–¥—ã–≤–∞–ª—Å—è –≤ `max_poll_interval_ms`<br>‚Ä¢ Heartbeat –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è | –£–≤–µ–ª–∏—á–∏–ª `max_poll_interval_ms` –¥–æ 5‚Äì10 –º–∏–Ω | –†–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥ —É—à—ë–ª, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Äî –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è (~1 RPS) |
| **v3**<br>_–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ async_ | –í–Ω–µ–¥—Ä–∏–ª–∏ `aiochclient` + `asyncio.Queue`<br>–†–∞–∑–¥–µ–ª–∏–ª–∏ —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å | ‚Ä¢ **–û—à–∏–±–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DateTime** –≤ ClickHouse 23.8<br>‚Ä¢ **ClickHouse –æ—Ç–∫–ª–æ–Ω—è–ª –¥–∞—Ç—ã** –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö | –ù–∞—É—á–∏–ª–∏—Å—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞—Ç—ã –∫–∞–∫ `'YYYY-MM-DD HH:MM:SS.mmm'` + `fmt=CSV` | –ó–∞–ø–∏—Å—å –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–æ –ø–æ—è–≤–∏–ª–∏—Å—å **–¥—É–±–ª–∏–∫–∞—Ç—ã** |
| **v4**<br>_–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å + –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è_ | ‚Ä¢ –ö–æ–º–º–∏—Ç Kafka **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏**<br>‚Ä¢ –¢–∞–±–ª–∏—Ü–∞: `ReplicatedReplacingMergeTree`<br>‚Ä¢ `ORDER BY (id, store_time)` | –î—É–±–ª–∏–∫–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –∏–∑-–∑–∞ –Ω–µ–ø–æ–ª–Ω–æ–π —Å—Ö–µ–º—ã –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è `OPTIMIZE` | –î–æ–±–∞–≤–∏–ª–∏ `store_time` –≤ `ORDER BY`, –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–º–º–∏—Ç | **–î—É–±–ª–∏–∫–∞—Ç—ã = 0** |
| **‚úÖ v5**<br>_Production-ready_ | ‚Ä¢ 2 —à–∞—Ä–¥–∞ √ó 2 —Ä–µ–ø–ª–∏–∫–∏ ClickHouse<br>‚Ä¢ 4 consumer'–∞ –≤ –≥—Ä—É–ø–ø–µ<br>‚Ä¢ Async –±–∞—Ç—á–∏–Ω–≥ + –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å<br>‚Ä¢ –ó–∞–ø—É—Å–∫ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é: —Å–µ—Ä–≤–∏—Å—ã ‚Üí consumer'—ã ‚Üí k6 | –í—ã—Å–æ–∫–∏–π e2e latency (–∏–∑-–∑–∞ –ø–æ—Å—Ç—Ñ–∞–∫—Ç—É–º –æ–±—Ä–∞–±–æ—Ç–∫–∏) | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: **—Å–∏—Å—Ç–µ–º–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞, —Å—Ç–∞–±–∏–ª—å–Ω–∞, –±–µ–∑ –ø–æ—Ç–µ—Ä—å** | **~9.3K RPS, 0 –æ—à–∏–±–æ–∫, 0 –¥—É–±–ª–µ–π** |

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **ClickHouse —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö (23.x).
2. **Kafka consumer group ‚Äî —Ö—Ä—É–ø–∫–∏–π –º–µ—Ö–∞–Ω–∏–∑–º**: –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ ‚Üí —Ä–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥ ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
3. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤ ClickHouse ‚Äî –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è**: `ReplacingMergeTree` —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ `ORDER BY` –∏/–∏–ª–∏ `argMax` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö.
4. **Async + –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã** –¥–ª—è highload ingestion.
5. **–ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ –∫—Ä–∏—Ç–∏—á–µ–Ω**: consumer'—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–∞–∫—Ç–∏–≤–Ω—ã –î–û –Ω–∞—á–∞–ª–∞ –Ω–∞–≥—Ä—É–∑–∫–∏**, –∏–Ω–∞—á–µ e2e latency = –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.

---

## üöÄ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- –û–±–Ω–æ–≤–∏—Ç—å ClickHouse –¥–æ **24.3+** ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ISO-—Å—Ç—Ä–æ–∫ ¬´–∏–∑ –∫–æ—Ä–æ–±–∫–∏¬ª.
- –ó–∞–º–µ–Ω–∏—Ç—å `aiochclient` –Ω–∞ **–Ω–∞—Ç–∏–≤–Ω—ã–π `clickhouse-driver` –≤ `ThreadPoolExecutor`** ‚Üí –≤—ã—à–µ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å.
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å **–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ lag'–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** (Prometheus + Grafana).
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ consumer'–æ–≤** –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É.