## üìå –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

‚úÖ **–ù–∞–≥—Ä—É–∑–∫–∞**:  
- **1‚ÄØ952‚ÄØ643** —Å–æ–±—ã—Ç–∏–π –∑–∞ **3m30s**  
- **9‚ÄØ282 RPS** (—É—Å–ø–µ—à–Ω–æ, 100% success rate)  
- **HTTP p95 latency**: **418 –º—Å**

‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ClickHouse**:  
- **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**: 1‚ÄØ952‚ÄØ643 –∑–∞–ø–∏—Å–µ–π ‚Üí 1‚ÄØ952‚ÄØ643 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö `id`  
- **–î—É–±–ª–∏–∫–∞—Ç–æ–≤: 0**  
- **e2e latency (ingest ‚Üí store)**: **~476 —Å–µ–∫ (–º–µ–¥–∏–∞–Ω–∞)**  
  > ‚ö†Ô∏è *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≤—ã—Å–æ–∫–∏–π e2e —Å–≤—è–∑–∞–Ω —Å —Ç–µ–º, —á—Ç–æ consumer'—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –æ—á–µ—Ä–µ–¥—å **–ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞** ‚Äî –Ω–æ —Å–∞–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞.*

‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:  
- **4 –Ω–æ–¥—ã ClickHouse**: 2 —à–∞—Ä–¥–∞ √ó 2 —Ä–µ–ø–ª–∏–∫–∏  
- **4 consumer'–∞** –≤ Kafka consumer group  
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞** —á–µ—Ä–µ–∑ `aiochclient` + –±–∞—Ç—á–∏–Ω–≥  
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**: `ReplacingMergeTree` + –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏

---

## üß≠ –≠–≤–æ–ª—é—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: –ø–æ–ª–Ω–∞—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è

| –≠—Ç–∞–ø | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|------|-------------|---------|--------|----------|
| **v0**<br>_–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã_ | ‚Ä¢ 3√ó FastAPI + nginx<br>‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `kafka-python`<br>‚Ä¢ 1 consumer | ‚Ä¢ **70% –æ—à–∏–±–æ–∫ –ø—Ä–∏ 3500 VU**<br>‚Ä¢ `EOF`, `connection reset`<br>‚Ä¢ CPU-–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ | –ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞–ª: **–ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ FastAPI, –∞ –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ Kafka** | –£–ø—Ä–æ—â–µ–Ω–∏–µ: **1√ó FastAPI**, —É–±—Ä–∞—Ç—å nginx |
| **v1**<br>_–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π consumer_ | FastAPI ‚Üí Kafka ‚Üí **–æ–¥–∏–Ω consumer** —Å `clickhouse-driver`<br>–ó–∞–ø–∏—Å—å –ø–æ –æ–¥–Ω–æ–º—É —Å–æ–±—ã—Ç–∏—é | ‚Ä¢ **–°–∏–ª—å–Ω–µ–π—à–∏–π –ª–∞–≥** (33+ –º–∏–Ω)<br>‚Ä¢ **Consumer –Ω–µ —Å–ø—Ä–∞–≤–ª—è–ª—Å—è —Å 1.2K RPS**<br>‚Ä¢ –ü–∞–¥–µ–Ω–∏—è –∏–∑-–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ event loop | –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ | –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å HTTP-—Å–ª–æ—è, –Ω–æ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ ‚Äî consumer |
| **v2**<br>_–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `aiokafka`_ | FastAPI + **`aiokafka`** ‚Üí Kafka ‚Üí Consumer (async) | ‚Ä¢ HTTP-—É—Ä–æ–≤–µ–Ω—å —Å—Ç–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω—ã–º (**1216 RPS, 0 –æ—à–∏–±–æ–∫**)<br>‚Ä¢ –ù–æ **consumer lag –≤—ã—Ä–æ—Å –¥–æ 33+ –º–∏–Ω** | –£–∑–∫–æ–µ –º–µ—Å—Ç–æ —Å–º–µ—Å—Ç–∏–ª–æ—Å—å **–Ω–∞ consumer ‚Üí ClickHouse** | –î–æ–∫–∞–∑–∞–Ω–æ: –∏–Ω–≥–µ—Å—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è, –Ω—É–∂–Ω–æ —É—Å–∫–æ—Ä—è—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É |
| **v3**<br>_–ü–æ–ø—ã—Ç–∫–∞ –±–∞—Ç—á–∏–Ω–≥–∞ –≤ consumer_ | Consumer –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è ‚Üí –±–∞—Ç—á-–≤—Å—Ç–∞–≤–∫–∞ –≤ ClickHouse | ‚Ä¢ **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥ Kafka**<br>‚Ä¢ Consumer –Ω–µ —É–∫–ª–∞–¥—ã–≤–∞–ª—Å—è –≤ `max_poll_interval_ms`<br>‚Ä¢ Heartbeat –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è | –£–≤–µ–ª–∏—á–∏–ª —Ç–∞–π–º–∞—É—Ç—ã, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å | –°—Ç–∞–ª–æ **–º–µ–¥–ª–µ–Ω–Ω–µ–µ** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ ~85 RPS |
| **v4**<br>_Async pipeline —Å –æ—á–µ—Ä–µ–¥—å—é_ | ‚Ä¢ `aiochclient` + `asyncio.Queue`<br>‚Ä¢ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ | ‚Ä¢ **–ü–æ—è–≤–∏–ª–∏—Å—å –¥—É–±–ª–∏–∫–∞—Ç—ã** (–∏–∑-–∑–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –±–µ–∑ –∫–æ–º–º–∏—Ç–∞)<br>‚Ä¢ **ClickHouse –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–ª –¥–∞—Ç—ã** (–æ—à–∏–±–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏)<br>‚Ä¢ **–í—ã—Å–æ–∫–∏–π CPU –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ** | ‚Ä¢ –ù–∞—É—á–∏–ª–∏—Å—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ<br>‚Ä¢ –ü–æ–¥–Ω—è–ª–∏ —Å–∏—Å—Ç–µ–º—É –≤ –æ–±–ª–∞–∫–æ –Ω–∞ NVMe | –°–∏—Å—Ç–µ–º–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–æ –¥—É–±–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å |
| **‚úÖ v5**<br>_Production-ready_ | ‚Ä¢ 2 —à–∞—Ä–¥–∞ √ó 2 —Ä–µ–ø–ª–∏–∫–∏ ClickHouse<br>‚Ä¢ `ReplacingMergeTree` —Å `ORDER BY (id, store_time)`<br>‚Ä¢ –ö–æ–º–º–∏—Ç Kafka **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏**<br>‚Ä¢ –ó–∞–ø—É—Å–∫: —Å–µ—Ä–≤–∏—Å—ã ‚Üí consumer'—ã ‚Üí k6 | –î—É–±–ª–∏–∫–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ `ORDER BY` (`ingest_time` –≤–º–µ—Å—Ç–æ `store_time`) | –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã ‚Üí **–¥—É–±–ª–∏ = 0** | **~9.3K RPS, 0 –æ—à–∏–±–æ–∫, 0 –¥—É–±–ª–µ–π** |

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ FastAPI –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º Kafka-–¥—Ä–∞–π–≤–µ—Ä–µ** ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–æ–≤.
2. **ClickHouse —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º—ã** –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.
3. **Kafka consumer group ‚Äî —Ö—Ä—É–ø–∫–∏–π –º–µ—Ö–∞–Ω–∏–∑–º**: –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ ‚Üí —Ä–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥ ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
4. **Async + –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã** –¥–ª—è highload ingestion.
5. **–ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ –∫—Ä–∏—Ç–∏—á–µ–Ω**: consumer'—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã –î–û –Ω–∞—á–∞–ª–∞ –Ω–∞–≥—Ä—É–∑–∫–∏, –∏ –ü–û–°–õ–ï —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –ë—Ä–æ–∫–µ—Ä–∞


## [TEST LOG](./ess_log_test.md)
## [–ù–ê–ó–ê–î](./ess.md)