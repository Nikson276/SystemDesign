---
title: "–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç –ª–æ–≥"
status: draft
version: 0.3
author: "–ú–∏—Ö–∞–π–ª–æ–≤ –ù–∏–∫–∏—Ç–∞"
date: 2025-12-09
tags: [k6, 3500VU, fail]
---

## üîß –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ **event-driven –ø–∞—Ç—Ç–µ—Ä–Ω—É** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ –∏–Ω–≥–µ—Å—Ç, –±—Ä–æ–∫–µ—Ä–∏–∑–∞—Ü–∏—é –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:

```
[ k6 / Client ]
       ‚Üì (HTTP)
[ nginx ] ‚Üí –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
       ‚Üì
[ FastAPI x3 ] ‚Üí 3 —Ä–µ–ø–ª–∏–∫–∏, 8 –≤–æ—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∏–Ω—Å—Ç–∞–Ω—Å (8 —è–¥–µ—Ä CPU)
       ‚Üì (KafkaProducer) - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä (kafka-python)
[ Apache Kafka ] ‚Üí 3-–Ω–æ–¥–æ–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä –≤ KRaft-—Ä–µ–∂–∏–º–µ
       ‚Üì (KafkaConsumer)
[ ClickHouse ] ‚Üí 4-–Ω–æ–¥–æ–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä (—Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è, –±–µ–∑ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∏ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è)
```

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Ä—Å–∏—è / –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|----------|------------------------|-----------|
| **FastAPI** | Python 3.10, Uvicorn | `--workers 8`, –±–µ–∑ `flush()` –≤ Kafka |
| **Kafka** | `apache/kafka:3.7.0`, KRaft | –¢–æ–ø–∏–∫ `nikson-test`: 12 –ø–∞—Ä—Ç–∏—Ü–∏–π, `replication_factor=3`, `min.insync.replicas=2` |
| **ClickHouse** | `clickhouse/clickhouse-server:23` | –¢–∞–±–ª–∏—Ü–∞ `example.events` (MergeTree, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü—É) |
| **Nginx** | `nginx:alpine` | Round-robin –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –º–µ–∂–¥—É 3 —Ä–µ–ø–ª–∏–∫–∞–º–∏ FastAPI |
| **Pyroscope** | `grafana/pyroscope:latest` | –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ CPU –∏ memory –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ |

---

## ESS —Ä–µ–≤—å—é –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ 3500 VU

### –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ç–µ—Å—Ç–∞–º –≤ —ç—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
WARN[0210] Request Failed                                error="Post \"http://nginx:80/events/\": EOF"
WARN[0210] Request Failed                                error="Post \"http://nginx:80/events/\": read tcp 172.20.0.13:58998->172.20.0.14:80: read: connection reset by peer"
WARN[0210] Request Failed                                error="Post \"http://nginx:80/events/\": EOF"
WARN[0210] Request Failed                                error="Post \"http://nginx:80/events/\": EOF"
WARN[0210] Request Failed                                error="Post \"http://nginx:80/events/\": EOF"
WARN[0210] Request Failed                                error="Post \"http://nginx:80/events/\": EOF"


  ‚ñà THRESHOLDS 

    http_reqs
    ‚úì 'count>=3500' count=149558


  ‚ñà TOTAL RESULTS 

    checks_total.......: 149558 706.738608/s
    checks_succeeded...: 29.50% 44127 out of 149558
    checks_failed......: 70.49% 105431 out of 149558

    ‚úó status equals 200
      ‚Ü≥  29% ‚Äî ‚úì 44127 / ‚úó 105431

    HTTP
    http_req_duration..............: avg=661.63ms min=0s       med=11.81ms max=4.96s p(90)=2.46s p(95)=2.86s
      { expected_response:true }...: avg=2.19s    min=2.44ms   med=2.18s   max=4.96s p(90)=3.12s p(95)=3.37s
    http_req_failed................: 70.49% 105431 out of 149558
    http_reqs......................: 149558 706.738608/s

    EXECUTION
    iteration_duration.............: avg=2.71s    min=868.61¬µs med=2.47s   max=9.46s p(90)=4.75s p(95)=5.36s
    iterations.....................: 149558 706.738608/s
    vus............................: 60     min=11               max=3490
    vus_max........................: 3500   min=3500             max=3500

    NETWORK
    data_received..................: 7.6 MB 36 kB/s
    data_sent......................: 14 MB  68 kB/s




running (3m31.6s), 0000/3500 VUs, 149558 complete and 0 interrupted iterations
default ‚úì [======================================] 0000/3500 VUs  3m30s
```

#### üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ (k6)

| –ù–∞–≥—Ä—É–∑–∫–∞ | RPS | –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | –ú–µ–¥–∏–∞–Ω–∞ latency (—É—Å–ø–µ—Ö) | –û—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ |
|---------|-----|------------------|--------------------------|-----------------|
| **2500 VU** | 355 | 100% | 2.11 —Å | –ù–µ—Ç |
| **3500 VU** | 628‚Äì706 | ~29% | 2.46 —Å | `EOF`, `connection reset by peer` |

> ‚úÖ **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: **~350‚Äì400 RPS** (2500 VU)  
> ‚ö†Ô∏è **–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏**: —Ä–µ–∑–∫–∏–π —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫ –∏–∑-–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤ FastAPI –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ Kafka.

### –í–æ–∑–≤—Ä–∞—Ç –∫ –æ–¥–Ω–æ–º—É FastAPI-–∏–Ω—Å—Ç–∞–Ω—Å—É. –ü–æ—á–µ–º—É —Ç–∞–∫ –ª—É—á—à–µ:

- **8 –≤–æ—Ä–∫–µ—Ä–æ–≤ Uvicorn –Ω–∞ 8 —è–¥—Ä–∞—Ö** ‚Äî —É–∂–µ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CPU**,
- **Nginx + 3 —Ä–µ–ø–ª–∏–∫–∏** ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç **–ª–∏—à–Ω–∏–π network hop** –∏ **–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é –∑–∞ —Ä–µ—Å—É—Ä—Å—ã** (–∫–æ–Ω—Ç–µ–∫—Å—Ç-—Å–≤–∏—á–∏, –∫—ç—à CPU),
- **–£–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã** ‚Üí –º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ –æ—Ç–∫–∞–∑–∞, –ø—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∫–∞ –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

> üí° **–í—ã–≤–æ–¥**: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ **–Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ Kafka-–¥—Ä–∞–π–≤–µ—Ä–∞**. –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å **–≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞**.


### **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Kafka-–¥—Ä–∞–π–≤–µ—Ä ‚Äî –∫–ª—é—á–µ–≤–æ–π —à–∞–≥**

–°–µ–π—á–∞—Å —É –º–µ–Ω—è:

```python
# kafka-python + run_in_executor ‚Üí –°–ò–ù–•–†–û–ù–ù–´–ô –≤—ã–∑–æ–≤ –≤ –ø—É–ª–µ –ø–æ—Ç–æ–∫–æ–≤
await loop.run_in_executor(None, self.producer.send, ...)
```

üëâ –≠—Ç–æ **—Ä–∞–∑—Ä—É—à–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –ø—Ä–∏—Ä–æ–¥—É FastAPI**:

- Event loop **–∂–¥—ë—Ç**, –ø–æ–∫–∞ –ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Kafka,
- –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ ‚Äî **–≤—Å–µ –≤–æ—Ä–∫–µ—Ä—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è**.

#### –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **`aiokafka`**

**`aiokafka`** ‚Äî —ç—Ç–æ **–Ω–∞—Ç–∏–≤–Ω—ã–π async-–∫–ª–∏–µ–Ω—Ç –¥–ª—è Kafka**, –∫–æ—Ç–æ—Ä—ã–π:

- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å `async/await`,
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop,
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏—á–∏ Kafka (KRaft, —Å–∂–∞—Ç–∏–µ, –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∏ —Ç.–¥.).

### üìå –ò—Ç–æ–≥–æ–≤—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å–¥–≤–∏–≥

| –ë—ã–ª–æ | –°—Ç–∞–Ω–µ—Ç |
|------|--------|
| 3√ó FastAPI + Nginx | **1√ó FastAPI (8 –≤–æ—Ä–∫–µ—Ä–æ–≤)** |
| `kafka-python` + `run_in_executor` | **`aiokafka` (–Ω–∞—Ç–∏–≤–Ω—ã–π async)** |
| –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Üí –Ω—É–ª–µ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** |
| –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ >400 RPS | **–¶–µ–ª—å: 1000+ RPS —Å <100 –º—Å latency** |

---

### üí™ –°–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è

1. –£–¥–∞–ª–∏ `nginx` –∏ `scale fastapi=3` –∏–∑ `docker-compose.yml`,
2. –£—Å—Ç–∞–Ω–æ–≤–∏ `aiokafka`,
3. –†–µ–∞–ª–∏–∑—É–π `AsyncKafkaProducerService`,
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç –Ω–∞ **2500 VU**.

---

## –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ –†–µ–≤—å—é 1

### ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **ess/kafka_consumer/consumer.py**: –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ `aiokafka` ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π.
   1. –í **ess/kafka_consumer/consumer.py._process_message**: –¥–æ–±–∞–≤–ª–µ–Ω –ó–∞–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ `API‚ÜíClickHouse latency`
2. **ess/app/services/kafka.py**: –í—ã–Ω–µ—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞—Ñ–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª producer, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `aiokafka` –∏ —è–≤–ª—è–µ—Ç—Å—è singleton
   1. `send_and_wait()` ‚Äî –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏,
   2. `send()` ‚Äî –µ—Å–ª–∏ fire-and-forget.
3. **ess/app/main.py**: –Ω–æ–≤—ã–π –ø—Ä–æ–¥—é—Å–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ FastAPI (lifespan)
4. **ess/app/routers/events.py**: –æ–±–Ω–æ–≤–ª–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
   1. **POST-—ç–Ω–¥–ø–æ–∏–Ω—Ç**: —Å—Ç–∞–ª `async` 
   2. **GET-—ç–Ω–¥–ø–æ–∏–Ω—Ç**: —Å—Ç–∞–ª `async` + `run_in_executor` –¥–ª—è ClickHouse.
5. **docker-compose**: –£–¥–∞–ª–∏–ª nginx service
6. **load-test.js**: –æ–±–Ω–æ–≤–∏–ª —Å–∫—Ä–∏–ø—Ç url –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤

–¢–µ–ø–µ—Ä—å  **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π pipeline**:

```bash
FastAPI (async) ‚Üí Kafka (aiokafka) ‚Üí Consumer (async) ‚Üí ClickHouse (run_in_executor)
```

## ESS –æ–±–∑–æ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è 3500 VU –ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–æ–∫

### –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ç–µ—Å—Ç–∞–º 

```bash

         /\      Grafana   /‚Äæ‚Äæ/  
    /\  /  \     |\  __   /  /   
   /  \/    \    | |/ /  /   ‚Äæ‚Äæ\ 
  /          \   |   (  |  (‚Äæ)  |
 / __________ \  |_|\_\  \_____/ 

     execution: local
        script: /scripts/load-test.js
        output: -

     scenarios: (100.00%) 1 scenario, 3500 max VUs, 4m0s max duration (incl. graceful stop):
              * default: Up to 3500 looping VUs for 3m30s over 4 stages (gracefulRampDown: 30s, gracefulStop: 30s)



  ‚ñà THRESHOLDS 

    http_reqs
    ‚úì 'count>=3500' count=258287


  ‚ñà TOTAL RESULTS 

    checks_total.......: 258287  1216.541136/s
    checks_succeeded...: 100.00% 258287 out of 258287
    checks_failed......: 0.00%   0 out of 258287

    ‚úì status equals 200

    HTTP
    http_req_duration..............: avg=1.54s min=902.64¬µs med=1.42s max=32.23s p(90)=2.58s p(95)=3.03s
      { expected_response:true }...: avg=1.54s min=902.64¬µs med=1.42s max=32.23s p(90)=2.58s p(95)=3.03s
    http_req_failed................: 0.00%  0 out of 258287
    http_reqs......................: 258287 1216.541136/s

    EXECUTION
    iteration_duration.............: avg=1.57s min=1.05ms   med=1.44s max=32.31s p(90)=2.64s p(95)=3.11s
    iterations.....................: 258287 1216.541136/s
    vus............................: 1080   min=15          max=3492
    vus_max........................: 3500   min=3500        max=3500

    NETWORK
    data_received..................: 37 MB  175 kB/s
    data_sent......................: 63 MB  296 kB/s




running (3m32.3s), 0000/3500 VUs, 258287 complete and 0 interrupted iterations
default ‚úì [======================================] 0000/3500 VUs  3m30s
```

### ‚úÖ –ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã  –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç 3500 VU (–≤–µ—Ä—Å–∏—è —Å `aiokafka`)

- **–ù–∞–≥—Ä—É–∑–∫–∞**: –¥–æ **3500 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: **1216 RPS**
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**: **100% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** (0 –æ—à–∏–±–æ–∫)
- **–ú–µ–¥–∏–∞–Ω–∞ latency**: **1.42 —Å–µ–∫**
- **p(95) latency**: **3.03 —Å–µ–∫**

### üîç –ù–∞–±–ª—é–¥–µ–Ω–∏—è –∏–∑ consumer latency

- **–°–∫–≤–æ–∑–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (API ‚Üí ClickHouse)**:
    
    - –ù–∞ —Å—Ç–∞—Ä—Ç–µ: **~0.5 —Å–µ–∫**
    - –ù–∞ –ø–∏–∫–µ –Ω–∞–≥—Ä—É–∑–∫–∏: **–¥–æ 240 —Å–µ–∫**
    
- **–ü—Ä–∏—á–∏–Ω–∞ —Ä–æ—Å—Ç–∞**: ClickHouse –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º RPS ‚Üí –æ—á–µ—Ä–µ–¥—å –≤ consumer —Ä–∞—Å—Ç—ë—Ç.

> üí° –≠—Ç–æ **—Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ consumer'–∞**, –Ω–æ **–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ HTTP-–æ—Ç–≤–µ—Ç** (FastAPI –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ä–∞–∑—É), —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å fire-and-forget –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

### üìå –í—ã–≤–æ–¥—ã

1. **FastAPI + aiokafka** ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç **>1200 RPS** —Å **–Ω—É–ª–µ–≤—ã–º —É—Ä–æ–≤–Ω–µ–º –æ—à–∏–±–æ–∫**.
2. **–£–∑–∫–æ–µ –º–µ—Å—Ç–æ —Å–º–µ—Å—Ç–∏–ª–æ—Å—å** —Å –∏–Ω–≥–µ—Å—Ç–∞ –Ω–∞ **consumer ‚Üí ClickHouse**.
3. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ **production-—ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏** –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ –¥–æ **1200 RPS** —Å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π latency.

### üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å consumer**: –±–∞—Ç—á-–≤—Å—Ç–∞–≤–∫–∏ –≤ ClickHouse, —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ consumer-–≤–æ—Ä–∫–µ—Ä–æ–≤.
- **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ lag'–∞**: –∞–ª–µ—Ä—Ç –ø—Ä–∏ —Ä–æ—Å—Ç–µ consumer lag > 60 —Å–µ–∫.
- **–î–ª—è —Ä–æ—Å—Ç–∞ RPS**: –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å **ClickHouse** (–±–æ–ª—å—à–µ —Ä–µ–ø–ª–∏–∫, SSD, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ MergeTree).

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–º–µ—Ä–∞ kafka –ª–∞–≥–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ Clickhouse

### ‚úÖ –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∑–∞–º–µ—Ä–∞ –ª–∞–≥–∞ –∑–∞–ø–∏—Å–∏ –≤ Clickhouse

- **ess/app/schemas/event.py** - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å —Å–æ–±—ã—Ç–∏—è –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ `ingest_time`, `store_time` –¥–ª—è –∑–∞–º–µ—Ä–∞ –ª–∞–≥–∞*
- **k6/load-test.js** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ –∑–∞–ø–æ–Ω–ª–µ–Ω–∏—é –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏
- **ess/scripts/init_all.py** - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π –≤ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ Clickhouse
- **ess/kafka_consumer/consumer.py._process_message** - –ó–∞–º–µ–Ω–∏–ª –∑–∞–º–µ—Ä latency –≤ stdout –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–æ–ª–µ `store_time` –∑–Ω–∞—á–µ–Ω–∏—è.

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–º–µ—Ä–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

Kafla Lag metric

```bash
SELECT
    count() AS total,
    avg(dateDiff('second', ingest_time, store_time)) AS avg_e2e_sec,
    quantiles(0.5, 0.9, 0.95, 0.99)(dateDiff('second', ingest_time, store_time)) AS p_latencies_sec
FROM example.events
WHERE store_time IS NOT NULL

Query id: 5e5a4cd0-af51-4f4c-a6cb-ca24fc409ce4

‚îå‚îÄ‚îÄtotal‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄavg_e2e_sec‚îÄ‚î¨‚îÄp_latencies_sec‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 266606 ‚îÇ 2005.4940061363961 ‚îÇ [1991.5,3578.9000000000005,3779,3920.09] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.011 sec. Processed 266.61 thousand rows, 4.27 MB (25.11 million rows/s., 401.71 MB/s.)
Peak memory usage: 757.59 KiB.

```

### üìä –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è |
|--------|----------|---------------|
| **–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π** | 266 606 | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ~1200 RPS √ó 222 —Å–µ–∫ ‚âà 266k ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω—ã–µ |
| **–°—Ä–µ–¥–Ω–∏–π e2e latency** | **~2005 —Å–µ–∫ = 33.4 –º–∏–Ω—É—Ç—ã** | ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å–æ–∫–∏–π –ª–∞–≥ |
| **–ú–µ–¥–∏–∞–Ω–∞ (p50)** | **1991 —Å–µ–∫ = 33.2 –º–∏–Ω—É—Ç—ã** | –ü–æ–ª–æ–≤–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∑–∞ **–±–æ–ª–µ–µ —á–µ–º –ø–æ–ª—á–∞—Å–∞** |
| **p95** | **3779 —Å–µ–∫ = 63 –º–∏–Ω—É—Ç—ã** | 5% —Å–æ–±—ã—Ç–∏–π –∂–¥–∞–ª–∏ **–±–æ–ª–µ–µ —á–∞—Å–∞** |
| **p99** | **3920 —Å–µ–∫ = 65 –º–∏–Ω—É—Ç** | –•–≤–æ—Å—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ ‚Äî **—Å–≤—ã—à–µ —á–∞—Å–∞** |

> üí• **–í—ã–≤–æ–¥**: consumer **–Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**.  
> –ü—Ä–∏ –ø–∏–∫–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ **–æ—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç—ë—Ç**, –∏ —Å–æ–±—ã—Ç–∏—è –∑–∞–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –Ω–∞ **–¥–µ—Å—è—Ç–∫–∏ –º–∏–Ω—É—Ç**.

---

### üîç –ü–æ—á–µ–º—É —Ç–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

#### 1. Consumer ‚Äî –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã–π

–¢—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å **–æ–¥–∏–Ω consumer**, –∫–æ—Ç–æ—Ä—ã–π:

- –ß–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ,
- –í—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Ö –≤ ClickHouse **–ø–æ –æ–¥–Ω–æ–º—É** (–∏–ª–∏ –º–µ–ª–∫–∏–º –±–∞—Ç—á–∞–º),
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ **–∫–∞–∂–¥—É—é –≤—Å—Ç–∞–≤–∫—É**.

–ü—Ä–∏ **1200 RPS**:

- ClickHouse –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å **~100‚Äì200 –≤—Å—Ç–∞–≤–æ–∫/—Å–µ–∫** (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏),
- ‚Üí Consumer **–Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç backlog** —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é **~1000 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫**.

#### 2. **ClickHouse –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è highload-–≤—Å—Ç–∞–≤–æ–∫**

- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ClickHouse **–Ω–µ –ª—é–±–∏—Ç —á–∞—Å—Ç—ã–µ –º–µ–ª–∫–∏–µ –≤—Å—Ç–∞–≤–∫–∏**,
- –ö–∞–∂–¥–∞—è –≤—Å—Ç–∞–≤–∫–∞ ‚Üí –≤—ã–∑–æ–≤ `INSERT` ‚Üí overhead –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–µ—Ä–∂.

---

### üí° –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –≤—ã–≤–æ–¥

–£—Å–ø–µ—à–Ω–æ **—Ä–∞–∑–¥–µ–ª–∏–ª–∏ –∏–Ω–≥–µ—Å—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É**:

- **FastAPI + aiokafka** ‚Äî —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å **1200+ RPS**,
- **Consumer ‚Üí ClickHouse** ‚Äî –Ω—É–∂–Ω–æ **–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å**.

–≠—Ç–æ **–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø–∞—Ç—Ç–µ—Ä–Ω-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:
> **"–ü—Ä–∏–Ω–∏–º–∞–π –±—ã—Å—Ç—Ä–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –ø–æ—Ç–æ–º"** ‚Äî –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

–¢–µ–ø–µ—Ä—å ‚Äî –æ—á–µ—Ä–µ–¥—å –∑–∞ **—É—Å–∫–æ—Ä–µ–Ω–∏–µ–º consumer pipeline**.

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è consumer pipeline (`Test-case-10-async`)

### ü•á –®–∞–≥ 1. **–ë–∞—Ç—á-–≤—Å—Ç–∞–≤–∫–∏** (—Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π ROI)

- –°–æ–±–∏—Ä–∞–π 1000‚Äì10000 —Å–æ–±—ã—Ç–∏–π –≤ –ø–∞–º—è—Ç–∏,
- –í—Å—Ç–∞–≤–ª—è–π **–æ–¥–Ω–∏–º `INSERT`** –≤ **–æ–¥–Ω—É –ª–æ–∫–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É**.

‚Üí –£–∂–µ –¥–∞—Å—Ç **10‚Äì100√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ**.

### ü•à –®–∞–≥ 2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ consumer'–æ–≤**

- –ó–∞–ø—É—Å—Ç–∏ 4 consumer'–∞,
- –ü—É—Å—Ç—å **–∫–∞–∂–¥—ã–π –ø–∏—à–µ—Ç –≤ —Å–≤–æ–π —à–∞—Ä–¥** (–≤—Ä—É—á–Ω—É—é: consumer-1 ‚Üí node1, consumer-2 ‚Üí node2...).

‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ 4 –Ω–æ–¥—ã **–±–µ–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ `Distributed`**.

### ü•â –®–∞–≥ 3. **–¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º ‚Äî `Distributed` + `Replicated`**

- –ö–æ–≥–¥–∞ –±—É–¥–µ—Ç **—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –±–∞—Ç—á–µ–π**,
- –ò **–ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**.

### ‚úÖ –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **ess/kafka_consumer/consumer.py** - –î–æ–±–∞–≤–∏–ª –±–∞—Ç—á–∏–Ω–≥ –≤ –º–µ—Ç–æ–¥—ã –∏ –∫–ª–∞—Å—Å.
- **docker-compose.yaml**:
  - –†–∞–∑–±–∏–ª service: `Consumer` –Ω–∞ 4 —à—Ç—É–∫–∏, —ç—Ç–æ –∫—Ä–∞—Ç–Ω–æ –∫–æ–ª-–≤—É –ø–∞—Ä—Ç–∏—Ü–∏–π (36) –∏ —ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç Kafka –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∫–æ–Ω—Å—å—é–º–µ—Ä –≥—Ä—É–ø–ø—ã `group_id`="event-statistics-service" —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏ –º–µ–∂–¥—É –Ω–∏–º–∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ (9 –Ω–∞ –∫–æ–Ω—Å—å—é–º–µ—Ä).
- **ess/scripts/init_all.py**:
  - –î–æ–±–∞–≤–ª–µ–Ω–æ `Distributed table` –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ Clickhouse.
  - 2 —à–∞—Ä–¥–∞ √ó 2 —Ä–µ–ø–ª–∏–∫–∏ = 4 –Ω–æ–¥—ã, —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
- **ess/app/services/clickhouse.py**:
  - –ó–∞–ø–∏—Å—å –∏–¥—ë—Ç –≤ example.events (Distributed), ClickHouse —Å–∞–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —à–∞—Ä–¥–∞–º –∏ —Ä–µ–ø–ª–∏–∫–∞–º
  - –ß—Ç–µ–Ω–∏–µ –∏–∑ example.events ‚Äî —Ç–æ–∂–µ —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å—ë —Å–æ –≤—Å–µ—Ö —à–∞—Ä–¥–æ–≤.

**–û–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

```
[Kafka: 36 –ø–∞—Ä—Ç–∏—Ü–∏–π]
       ‚Üì
[Consumer Group: 4 consumer'–∞] ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª—è—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ (9 –Ω–∞ consumer)
       ‚Üì
[ClickHouse: 4 –Ω–æ–¥—ã] ‚Üí –∫–∞–∂–¥—ã–π consumer –ø–∏—à–µ—Ç –≤ –æ–¥–Ω—É –Ω–æ–¥—É –≤ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, clickhouse —Å–∞–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ —à–∞—Ä–¥–∞–º –∏ –ø–∏—à–µ—Ç —Ä–µ–ø–ª–∏–∫–∏.
```

### –û–∂–∏–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- Throughput consumer'–æ–≤ –≤—ã—Ä–∞—Å—Ç–µ—Ç –≤ ~4 —Ä–∞–∑–∞,
- e2e latency —É–ø–∞–¥—ë—Ç —Å 33 –º–∏–Ω—É—Ç –¥–æ —Å–µ–∫—É–Ω–¥,
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–Ω–µ—Ç truly parallel

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∑–∞–º–µ—Ä—ã

```bash

         /\      Grafana   /‚Äæ‚Äæ/  
    /\  /  \     |\  __   /  /   
   /  \/    \    | |/ /  /   ‚Äæ‚Äæ\ 
  /          \   |   (  |  (‚Äæ)  |
 / __________ \  |_|\_\  \_____/ 

     execution: local
        script: /scripts/load-test.js
        output: -

     scenarios: (100.00%) 1 scenario, 3500 max VUs, 4m0s max duration (incl. graceful stop):
              * default: Up to 3500 looping VUs for 3m30s over 4 stages (gracefulRampDown: 30s, gracefulStop: 30s)

WARN[0169] Could not get a VU from the buffer for 400ms  executor=ramping-vus scenario=default


  ‚ñà THRESHOLDS 

    http_reqs
    ‚úì 'count>=3500' count=300165


  ‚ñà TOTAL RESULTS 

    checks_total.......: 300165  1416.423648/s
    checks_succeeded...: 100.00% 300165 out of 300165
    checks_failed......: 0.00%   0 out of 300165

    ‚úì status equals 200

    HTTP
    http_req_duration..............: avg=1.31s min=3.17ms med=1.16s max=16.02s p(90)=2.33s p(95)=2.82s
      { expected_response:true }...: avg=1.31s min=3.17ms med=1.16s max=16.02s p(90)=2.33s p(95)=2.82s
    http_req_failed................: 0.00%  0 out of 300165
    http_reqs......................: 300165 1416.423648/s

    EXECUTION
    iteration_duration.............: avg=1.34s min=3.61ms med=1.18s max=16.04s p(90)=2.38s p(95)=2.91s
    iterations.....................: 300165 1416.423648/s
    vus............................: 2123   min=0           max=3499
    vus_max........................: 3500   min=3495        max=3500

    NETWORK
    data_received..................: 43 MB  204 kB/s
    data_sent......................: 71 MB  336 kB/s




running (3m31.9s), 0000/3500 VUs, 300165 complete and 0 interrupted iterations
default ‚úì [======================================] 0000/3500 VUs  3m30s
```

#### –ù–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã (–∫–æ–Ω—Å—å—é–º–µ—Ä—ã —É–ø–∞–ª–∏, –∏–ª–∏ —á—Ç–æ)

–í clickhouse –ø–æ–ø–∞–ª–æ –≤—Å–µ–≥–æ 12,5–∫ —Å–æ–æ–±—ã—Ç–∏–π –∏–∑ 300–∫

–ü–æ—á–µ–º—É —Ä–∞–∑–±–∏—Ä–∞—é—Å—å.

–ª–æ–≥–∏ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞:
```bash
consumer-1  | Group Coordinator Request failed: [Error 15] GroupCoordinatorNotAvailableError
consumer-1  | Marking the coordinator dead (node 2)for group event-statistics-service.
```
–ê –≤ —Å–µ—Ä–≤–∏—Å–µ kafka-0 –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ñ—Å–µ—Ç –≤—ã–¥–∞–ª–æ –æ—à–∏–±–∫—É:
```bash
Error: Executing consumer group command failed due to org.apache.kafka.common.errors.TimeoutException: Timed out waiting for a node assignment. Call: describeGroups(api=FIND_COORDINATOR)
java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException: Timed out waiting for a node assignment. Call: describeGroups(api=FIND_COORDINATOR)
        at java.base/java.util.concurrent.CompletableFuture.reportGet(Unknown Source)
        at java.base/java.util.concurrent.CompletableFuture.get(Unknown Source)
        at org.apache.kafka.common.internals.KafkaFutureImpl.get(KafkaFutureImpl.java:165)
        at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.$anonfun$describeConsumerGroups$1(ConsumerGroupCommand.scala:551)
        at scala.collection.StrictOptimizedMapOps.map(StrictOptimizedMapOps.scala:28)
        at scala.collection.StrictOptimizedMapOps.map$(StrictOptimizedMapOps.scala:27)
        at scala.collection.convert.JavaCollectionWrappers$AbstractJMapWrapper.map(JavaCollectionWrappers.scala:344)
        at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.describeConsumerGroups(ConsumerGroupCommand.scala:550)
        at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.collectGroupsOffsets(ConsumerGroupCommand.scala:566)
        at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.describeGroups(ConsumerGroupCommand.scala:374)
        at kafka.admin.ConsumerGroupCommand$.run(ConsumerGroupCommand.scala:72)
        at kafka.admin.ConsumerGroupCommand$.main(ConsumerGroupCommand.scala:59)
        at kafka.admin.ConsumerGroupCommand.main(ConsumerGroupCommand.scala)
Caused by: org.apache.kafka.common.errors.TimeoutException: Timed out waiting for a node assignment. Call: describeGroups(api=FIND_COORDINATOR)
```

**–í kafka ui**

- –≤–∏–∂—É –Ω–∞ —Ç–æ–ø–∏–∫–µ - Total lag = 287406
- –ø—Ä–∏ –æ–±—â–µ–º Message Count = 300166

–∫–∞–∂–µ—Ç—Å—è –Ω–∞—à–ª–æ—Å—å –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–µ. –Ø–≤–Ω–æ —á—Ç–æ-—Ç–æ —Å –∫–æ–Ω—Å—å—é–º–µ—Ä–∞–º–∏ –º—ã –Ω–∞–º—É–¥—Ä–∏–ª–∏.

##### –ê–ù–∞–ª–∏–∑ 

> –û—à–∏–±–∫–∞ GroupCoordinatorNotAvailableError –∏ TimeoutException: Timed out waiting for a node assignment –æ–∑–Ω–∞—á–∞—é—Ç, —á—Ç–æ Kafka –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞ –¥–ª—è consumer group, –∏ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è —Ç–≤–æ–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞.
> Consumer group coordinator ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤, –∏ –µ—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª –∫–≤–æ—Ä—É–º ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
üí° GroupCoordinatorNotAvailableError = "–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –Ω–µ –∏–∑–±—Ä–∞–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω".

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–ª–∞—Å—Ç–µ—Ä–∞
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ docker compose up Kafka-–Ω–æ–¥—ã –Ω–µ —É—Å–ø–µ–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–≤–æ—Ä—É–º –¥–æ –∑–∞–ø—É—Å–∫–∞ consumer'–æ–≤.
- –û–¥–∏–Ω –∏–∑ –±—Ä–æ–∫–µ—Ä–æ–≤ —É–ø–∞–ª –∏–ª–∏ –Ω–µ –≤ —Å–µ—Ç–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è KAFKA_CONTROLLER_QUORUM_VOTERS

–£ –º–µ–Ω—è:
```yaml
KAFKA_CONTROLLER_QUORUM_VOTERS: "0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093"
```
‚Üí –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –µ—Å–ª–∏ –æ–¥–Ω–∞ –Ω–æ–¥–∞ –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∞ ‚Äî –∫–≤–æ—Ä—É–º –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è.

**–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?**

- –û–±–Ω–æ–≤–∏ docker-compose.yml ‚Äî –¥–æ–±–∞–≤—å init-schemas –∫–∞–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è consumer'–æ–≤, –∏ —É–¥–∞–ª–∏ consumer'—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

```bash
# –ü—Ä–æ–≤–µ—Ä—å, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
docker compose exec kafka-0 /opt/kafka/bin/kafka-metadata-quorum.sh --bootstrap-server localhost:9092 describe --status

ClusterId:              Some(abcdefghijklmnopqrstuv)
LeaderId:               1
LeaderEpoch:            1
HighWatermark:          910
MaxFollowerLag:         0
MaxFollowerLagTimeMs:   461
CurrentVoters:          [0,1,2]
CurrentObservers:       []
```

**–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:**

- LeaderId: 1 ‚Üí –Ω–æ–¥–∞ kafka-1 ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (—ç—Ç–æ –∏ –µ—Å—Ç—å "ActiveController").
- CurrentVoters: [0,1,2] ‚Üí –≤—Å–µ 3 –Ω–æ–¥—ã —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –∫–≤–æ—Ä—É–º–µ.
- MaxFollowerLag: 0 ‚Üí –≤—Å–µ –Ω–æ–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.

üëâ –í—ã–≤–æ–¥: KRaft-–∫–≤–æ—Ä—É–º —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏–∑–±—Ä–∞–Ω.

### –î–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–º–µ—Ä `Test-case-11-async`

–ó–∞–º–µ—Ä—ã k6

```bash

         /\      Grafana   /‚Äæ‚Äæ/  
    /\  /  \     |\  __   /  /   
   /  \/    \    | |/ /  /   ‚Äæ‚Äæ\ 
  /          \   |   (  |  (‚Äæ)  |
 / __________ \  |_|\_\  \_____/ 

     execution: local
        script: /scripts/load-test.js
        output: -

     scenarios: (100.00%) 1 scenario, 3500 max VUs, 4m0s max duration (incl. graceful stop):
              * default: Up to 3500 looping VUs for 3m30s over 4 stages (gracefulRampDown: 30s, gracefulStop: 30s)



  ‚ñà THRESHOLDS 

    http_reqs
    ‚úì 'count>=3500' count=328780


  ‚ñà TOTAL RESULTS 

    checks_total.......: 328780  1549.150089/s
    checks_succeeded...: 100.00% 328780 out of 328780
    checks_failed......: 0.00%   0 out of 328780

    ‚úì status equals 200

    HTTP
    http_req_duration..............: avg=1.21s min=2.34ms med=1.08s max=26.34s p(90)=2.1s  p(95)=2.49s
      { expected_response:true }...: avg=1.21s min=2.34ms med=1.08s max=26.34s p(90)=2.1s  p(95)=2.49s
    http_req_failed................: 0.00%  0 out of 328780
    http_reqs......................: 328780 1549.150089/s

    EXECUTION
    iteration_duration.............: avg=1.23s min=2.74ms med=1.1s  max=26.34s p(90)=2.13s p(95)=2.53s
    iterations.....................: 328780 1549.150089/s
    vus............................: 2046   min=15          max=3493
    vus_max........................: 3500   min=3500        max=3500

    NETWORK
    data_received..................: 47 MB  223 kB/s
    data_sent......................: 81 MB  379 kB/s




running (3m32.2s), 0000/3500 VUs, 328780 complete and 0 interrupted iterations
default ‚úì [======================================] 0000/3500 VUs  3m30s
```

#### –ê–Ω–∞–ª–∏–∑

–ó–∞–ø—Ä–æ—Å –∫ Clickhouse

```bash
SELECT
    count() AS total,
    avg(dateDiff('second', ingest_time, store_time)) AS avg_e2e_sec,
    quantiles(0.5, 0.9, 0.95, 0.99)(dateDiff('second', ingest_time, store_time)) AS p_latencies_sec
FROM example.events
WHERE store_time IS NOT NULL

Query id: b2003cd8-3dee-4bb9-b7aa-20f559183b72

‚îå‚îÄtotal‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄavg_e2e_sec‚îÄ‚î¨‚îÄp_latencies_sec‚îÄ‚îê
‚îÇ  9632 ‚îÇ 0.8911960132890365 ‚îÇ [1,2,2,3]       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.008 sec. Processed 9.63 thousand rows, 154.11 KB (1.19 million rows/s., 19.01 MB/s.)
Peak memory usage: 525.16 KiB.
```

–í kafka UI –≤–∏–∂—É —á—Ç–æ Message Count = 328780
–ù–∞ consumer-group —É–∫–∞–∑–∞–Ω–æ Total lag = 318940 
–¢.–µ. –æ–ø—è—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å–ª–∞
–ù–æ –∫–∞–∫ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—á–µ–º—É? 

–ó–∞–ø—Ä–æ—Å

```bash
 docker compose exec kafka-0 /opt/kafka/bin/kafka-metadata-quorum.sh --bootstrap-server localhost:9092 describe --status
ClusterId:              Some(abcdefghijklmnopqrstuv)
LeaderId:               0
LeaderEpoch:            2
HighWatermark:          16000
MaxFollowerLag:         0
MaxFollowerLagTimeMs:   0
CurrentVoters:          [0,1,2]
CurrentObservers:       []
```

```bash
$ docker compose exec kafka-0 /opt/kafka/bin/kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group event-statistics-service \
  --describe

Consumer group 'event-statistics-service' has no active members.
```

–µ—â–µ –ø—Ä–æ–≤–µ—Ä–∏–ª –ª–æ–≥–∏ –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤

```bash
$ docker compose logs consumer-1
consumer-1  | Heartbeat failed for group event-statistics-service because it is rebalancing
```

–ò —Å—É–¥—è –ø–æ docker compose stats –≤—Å–µ 4 –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω—ã

—á—Ç–æ –Ω–µ —Ç–∞–∫? 

> –ü—Ä–∏—á–∏–Ω–∞: –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥ consumer group
> Kafka **–Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥**, –∫–æ–≥–¥–∞:

1. Consumer **–ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∏–ª–∏ –ø–æ–∫–∏–¥–∞–µ—Ç –≥—Ä—É–ø–ø—É**,
2. Consumer **–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat –≤–æ–≤—Ä–µ–º—è**,
3. Consumer **–Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∑–∞ `max.poll.interval.ms`**

–ú–æ–π –ø—É–Ω–∫—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ 3: Consumer –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –±–∞—Ç—á –∑–∞ –æ—Ç–≤–µ–¥—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è ‚Üí Kafka —Å—á–∏—Ç–∞–µ—Ç –µ–≥–æ –º—ë—Ä—Ç–≤—ã–º ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–µ–±–∞–ª–∞–Ω—Å ‚Üí consumer –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí —Ü–∏–∫–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è.

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑ –ª–æ–≥–æ–≤**

- **`Heartbeat failed ... rebalancing`** ‚Üí consumer –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª heartbeat,
- **`No active members`** ‚Üí –≤—Å–µ consumer'—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∞,
- **`Total lag = 318 940`** ‚Üí consumer'—ã **–Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è**,
- **ClickHouse: —Ç–æ–ª—å–∫–æ 9632 —Å—Ç—Ä–æ–∫** ‚Üí consumer'—ã **–Ω–∞—á–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É, –Ω–æ –∑–∞–≤–∏—Å–ª–∏**.

üëâ –≠—Ç–æ **–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–∏–º–ø—Ç–æ–º —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è**.

#### üîß –†–µ—à–µ–Ω–∏–µ: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `session.timeout.ms` –∏ `max.poll.interval.ms`

–í `aiokafka` —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ consumer'–∞.

–û–±–Ω–æ–≤–∏—Ç—å `AsyncKafkaConsumerService`:

```python
# ess/kafka_consumer/consumer.py
self.consumer = AIOKafkaConsumer(
    settings.kafka_topic,
    bootstrap_servers=settings.kafka_bootstrap_servers,
    group_id="event-statistics-service",
    auto_offset_reset="earliest",
    enable_auto_commit=False,
    # –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
    session_timeout_ms=45000,        # –≤—Ä–µ–º—è –Ω–∞ heartbeat (–¥–µ—Ñ–æ–ª—Ç 45s)
    heartbeat_interval_ms=15000,     # –æ—Ç–ø—Ä–∞–≤–∫–∞ heartbeat –∫–∞–∂–¥—ã–µ 15s
    max_poll_interval_ms=300000,     # –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –±–∞—Ç—á–∞ ‚Äî 5 –º–∏–Ω—É—Ç!
)
```
üí° max_poll_interval_ms=300000 (5 –º–∏–Ω—É—Ç) ‚Äî –¥–∞—ë—Ç consumer'—É –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –±–æ–ª—å—à–æ–≥–æ –±–∞—Ç—á–∞.

–ù–ï –ü–û–ú–û–ì–õ–û `:(`

#### –ù–û–í–´–ô –ü–õ–ê–ù

–ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±–µ—Ä—ë–º –±–∞—Ç—á–∏–Ω–≥ –∏–∑ consumer'–∞ –∏ –ø–µ—Ä–µ–ø–∏—à–µ–º –∑–∞–ø–∏—Å—å –≤ ClickHouse —á–µ—Ä–µ–∑ –º–∞—Å—Å–∏–≤–Ω—É—é –≤—Å—Ç–∞–≤–∫—É (executemany) ‚Äî —ç—Ç–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ, –±—ã—Å—Ç—Ä–æ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Kafka heartbeat'–∞–º–∏.

> –ö–∞–∂–µ—Ç—Å—è —Å—Ä–∞–±–æ—Ç–∞–ª–æ. 
> –ò—Ç–æ–≥–æ: —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å –±–∞—Ç—á–∏–Ω–≥–æ–º –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ –±—ã–ª–∏ –Ω–µ —É–¥–∞—á–Ω—ã–µ. –õ–æ–≥–∏ –≤—ã—à–µ.
> –°–µ–π—á–∞—Å –∂–¥—É –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ–≥–æ –ª–∞–≥–∞, –∏ –ø—Ä–æ–≤–µ—Ä—é —Ñ–∏–Ω–∏—à.

P.S. - –†–∞–±–æ—Ç–∞ –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è. –ó–∞ 5 –º–∏–Ω 20–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, –∏–∑ 300–∫ `:(`

–¢–ê–∫ —á—Ç–æ –Ω–∞–¥–æ —É–±–∏—Ä–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –∏ —É clickhouse –Ω–∞  –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è ClickHouse

üìå –¶–µ–ª—å
–†–∞–∑–¥–µ–ª–∏—Ç—å —á—Ç–µ–Ω–∏–µ –∏–∑ Kafka –∏ –∑–∞–ø–∏—Å—å –≤ ClickHouse —á–µ—Ä–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞—Ç–∏–≤–Ω—ã–µ async-–¥—Ä–∞–π–≤–µ—Ä—ã.

üîß –®–∞–≥ 1. –ó–∞–º–µ–Ω–∏ clickhouse-driver –Ω–∞ aiochclient

```bash
#–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä
pip install aiochclient –∏–ª–∏ pip install clickhouse-driver[asynch]
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
Kafka Consumer Task ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–ª–∞–¥—ë—Ç –≤ async.Queue.
Batch Collector Task ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ –ø–∏—à–µ—Ç –±–∞—Ç—á–∞–º–∏ –≤ ClickHouse.
–û–±—â–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å ‚Äî asyncio.Queue(maxsize=10000).

### –ó–∞–º–µ—Ä –ª–∞–≥–∞ –≤ –∏—Ç–æ–≥–µ

–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —Å –º–∏–Ω –ø–æ—Ç–µ—Ä—è–º–∏

```bash
  ‚ñà THRESHOLDS 

    http_reqs
    ‚úì 'count>=3500' count=153566


  ‚ñà TOTAL RESULTS 

    checks_total.......: 153566 714.775824/s
    checks_succeeded...: 99.86% 153354 out of 153566
    checks_failed......: 0.13%  212 out of 153566

    ‚úó status equals 200
      ‚Ü≥  99% ‚Äî ‚úì 153354 / ‚úó 212

    HTTP
    http_req_duration..............: avg=2.59s min=1.05ms med=2.1s  max=40.82s p(90)=4.9s  p(95)=5.83s
      { expected_response:true }...: avg=2.59s min=1.05ms med=2.11s max=40.82s p(90)=4.9s  p(95)=5.83s
    http_req_failed................: 0.13%  212 out of 153566
    http_reqs......................: 153566 714.775824/s

    EXECUTION
    iteration_duration.............: avg=2.67s min=1.24ms med=2.16s max=40.83s p(90)=5.02s p(95)=6.01s
    iterations.....................: 153566 714.775824/s
    vus............................: 139    min=17            max=3494
    vus_max........................: 3500   min=3500          max=3500

    NETWORK
    data_received..................: 22 MB  103 kB/s
    data_sent......................: 38 MB  175 kB/s




running (3m34.8s), 0000/3500 VUs, 153566 complete and 0 interrupted iterations
default ‚úì [======================================] 0000/3500 VUs  3m30s
```

–õ–∞–≥ –∑–∞–ø–∏—Å–∏ –≤ –°lickhouse 

```bash
SELECT
    count() AS total,
    avg(dateDiff('second', ingest_time, store_time)) AS avg_e2e_sec,
    quantiles(0.5, 0.9, 0.95, 0.99)(dateDiff('second', ingest_time, store_time)) AS p_latencies_sec
FROM example.events
WHERE store_time IS NOT NULL

Query id: bdd7299b-91ba-47a6-9c99-07a87afb7c4d

‚îå‚îÄ‚îÄtotal‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄavg_e2e_sec‚îÄ‚î¨‚îÄp_latencies_sec‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 281489 ‚îÇ 1063.549037440184 ‚îÇ [1031,1903,2009,2110] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.529 sec. Processed 281.49 thousand rows, 4.50 MB (531.86 thousand rows/s., 8.51 MB/s.)
Peak memory usage: 624.38 KiB.
```

#### –ê–Ω–∞–ª–∏–∑ 

- –ü–æ—á–µ–º—É **–∑–∞–ø–∏—Å–µ–π –≤ ClickHouse –±–æ–ª—å—à–µ**, —á–µ–º HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤,
- –ü–æ—á–µ–º—É **–ª–∞–≥ –≤—Å—ë –µ—â—ë –≤—ã—Å–æ–∫–∏–π**,

1. –ü–æ—á–µ–º—É `281 489` –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ—Ç–∏–≤ `153 354` HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤?
–≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ consumer'–æ–≤ –±–µ–∑ `enable_auto_commit=False`**
–ï—Å–ª–∏ consumer **–Ω–µ —É—Å–ø–µ–ª –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –æ—Ñ—Å–µ—Ç –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ**, Kafka **–ø–æ–≤—Ç–æ—Ä–∏—Ç –¥–æ—Å—Ç–∞–≤–∫—É** —Ç–µ—Ö –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ.

‚Üí –¢—ã **–ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —Å–æ–±—ã—Ç–∏—è**, –∏ ClickHouse **–≤—Å—Ç–∞–≤–∏–ª –∏—Ö –µ—â—ë —Ä–∞–∑** (–ø–æ—Ç–æ–º—É —á—Ç–æ —É —Ç–µ–±—è **–Ω–µ—Ç `PRIMARY KEY` –∏–ª–∏ `ReplacingMergeTree`**).

> üí° **ClickHouse ‚Äî append-only**, –∏ `INSERT` **–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

```sql
-- –ï—Å—Ç—å –ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ id?
SELECT id, count() 
FROM example.events 
GROUP BY id 
HAVING count() > 1 
LIMIT 10;

Query id: 749c7e72-951a-4f17-a09d-d76d2863d69c

‚îå‚îÄid‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄcount()‚îÄ‚îê
‚îÇ event-1411-18 ‚îÇ       2 ‚îÇ
‚îÇ event-2844-7  ‚îÇ       2 ‚îÇ
‚îÇ event-711-42  ‚îÇ       2 ‚îÇ
‚îÇ event-719-52  ‚îÇ       2 ‚îÇ
‚îÇ event-312-64  ‚îÇ       2 ‚îÇ
‚îÇ event-1074-2  ‚îÇ       2 ‚îÇ
‚îÇ event-831-27  ‚îÇ       2 ‚îÇ
‚îÇ event-899-22  ‚îÇ       2 ‚îÇ
‚îÇ event-1553-9  ‚îÇ       2 ‚îÇ
‚îÇ event-3404-0  ‚îÇ       2 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

10 rows in set. Elapsed: 0.105 sec. Processed 288.21 thousand rows, 6.11 MB (2.74 million rows/s., 57.99 MB/s.)
Peak memory usage: 53.22 MiB.
```

–ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤ **–ø–æ–≤—Ç–æ—Ä–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–µ + –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏**.

–†–µ–∑—É–ª—å—Ç–∞—Ç: - –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã.

2. –ü–æ—á–µ–º—É –ª–∞–≥ –≤—Å—ë –µ—â—ë –≤—ã—Å–æ–∫–∏–π (~17 –º–∏–Ω—É—Ç)?

- **–ú–µ–¥–∏–∞–Ω–∞ `e2e latency = 1031 —Å–µ–∫ = 17 –º–∏–Ω—É—Ç`** ‚Äî —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **consumer'—ã –Ω–∞—á–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–æ–ª—å–∫–æ —Å–ø—É—Å—Ç—è 15‚Äì20 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞**.
- –≠—Ç–æ **–Ω–µ –ø—Ä–æ–±–ª–µ–º–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏**, –∞ **–ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–ø—É—Å–∫–∞**: consumer'—ã **—Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ** –∏–ª–∏ **–∑–∞–≤–∏—Å–ª–∏ –≤ —Ä–µ–±–∞–ª–∞–Ω—Å–∏–Ω–≥–µ –≤ –Ω–∞—á–∞–ª–µ**.

> üí° Kafka **–Ω–µ —Ç–µ—Ä—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è**, –Ω–æ –µ—Å–ª–∏ consumer –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è **—á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ—Å—Ç–∞** ‚Äî –≤—Å–µ 153k —Å–æ–±—ã—Ç–∏–π –±—É–¥—É—Ç –∏–º–µ—Ç—å `store_time - ingest_time ‚âà 15 –º–∏–Ω—É—Ç`.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –í–∫–ª—é—á–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –≤ ClickHouse

–ò–∑–º–µ–Ω–∏—Ç—å –¥–≤–∏–∂–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ `ReplacingMergeTree`:

```sql
ENGINE = ReplicatedReplacingMergeTree(
    '/clickhouse/company_cluster/tables/{shard}/events_local',
    '{replica}',
    store_time  -- –∏–ª–∏ (ingest_time, store_time)
)
ORDER BY (id, ingest_time);
```

üí° `ReplacingMergeTree` **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã** –ø—Ä–∏ –º–µ—Ä–∂–µ (–Ω–æ –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ñ–æ–Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö).

### –ù–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω —Ç–µ—Å—Ç–æ–≤

!! –ü—Ä–æ–≤–µ—Ä—å logs consumer-1 | grep Inserted batch of
–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–µ—Ç–æ–¥ `async def _flush_batch` –∫–∞–∫ –±–∞—Ç—á–∏

135 353 
5341 -- 7812 -- 10364 -- 13071 -- 15940 -- 18378 -- 20948 -- 24941

#### üìä –†–∞—Å—á—ë—Ç —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏

| –í—Ä–µ–º—è (—Å–µ–∫) | –ó–∞–ø–∏—Å–µ–π –≤ ClickHouse | –ü—Ä–∏—Ä–æ—Å—Ç –∑–∞ 30 —Å–µ–∫ | –°–∫–æ—Ä–æ—Å—Ç—å (RPS) |
|------------|----------------------|-------------------|----------------|
| 0          | 5341                 | -                 | -              |
| 30         | 7812                 | 2471              | **82**         |
| 60         | 10364                | 2552              | **85**         |
| 90         | 13071                | 2707              | **90**         |
| 120        | 15940                | 2869              | **96**         |
| 150        | 18378                | 2438              | **81**         |
| 180        | 20948                | 2570              | **86**         |

üëâ **–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å: ~85 RPS**

##### –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:

- –¢—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å **~5100 —Å–æ–±—ã—Ç–∏–π/–º–∏–Ω—É—Ç—É**,
- **328k —Å–æ–±—ã—Ç–∏–π –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∑–∞ ~64 –º–∏–Ω—É—Ç—ã**.

##### –ü–æ—á–µ–º—É —Ç–∞–∫ –º–µ–¥–ª–µ–Ω–Ω–æ?

1. **ClickHouse –Ω–∞ HDD –∏–ª–∏ —Å–ª–∞–±–æ–º SSD** ‚Äî –≤—Å—Ç–∞–≤–∫–∞ –≤ `MergeTree` —Ç—Ä–µ–±—É–µ—Ç –¥–∏—Å–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π,
2. **–°–µ—Ç–µ–≤–æ–π –æ–≤–µ—Ä—Ö–µ–¥** –º–µ–∂–¥—É consumer'–∞–º–∏ –∏ ClickHouse,
3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ consumer'–∞** ‚Äî –¥–∞–∂–µ —Å `aiochclient` –µ—Å—Ç—å –ø—Ä–µ–¥–µ–ª.

##### –ü—Ä–æ–≤–µ—Ä–∫–∏

**–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ClickHouse**
```bash
docker stats clickhouse-node1 clickhouse-node2 clickhouse-node3 clickhouse-node4
```
‚Üí –ï—Å–ª–∏ **CPU < 50%** ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ **–Ω–µ –≤ ClickHouse**, –∞ –≤ consumer'–∞—Ö.

**–£–∑–∫–æ–µ –º–µ—Å—Ç–æ**: **ClickHouse-–Ω–æ–¥—ã –≥—Ä—É–∑—è—Ç CPU –Ω–∞ 78‚Äì115%**, –∏ —ç—Ç–æ **–ª–∏–º–∏—Ç–∏—Ä—É–µ—Ç –≤—Å—é —Å–∏—Å—Ç–µ–º—É**.

–ü–æ—á–µ–º—É ClickHouse ‚Äî —É–∑–∫–æ–µ –º–µ—Å—Ç–æ?

1. **`MergeTree` —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ CPU** –¥–ª—è:
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ,
   - –°–∂–∞—Ç–∏—è –∫–æ–ª–æ–Ω–æ–∫,
   - –§–æ–Ω–æ–≤—ã—Ö –º–µ—Ä–∂–µ–π (merge parts).
2. **4 –Ω–æ–¥—ã ClickHouse –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ** ‚Üí –æ–Ω–∏ **–∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ CPU –∏ I/O**.
3. **–õ–æ–∫–∞–ª—å–Ω—ã–π SSD/HDD** ‚Äî –º–æ–∂–µ—Ç –Ω–µ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å 4-–∫—Ä–∞—Ç–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –∑–∞–ø–∏—Å–∏.

> üí° **ClickHouse ‚Äî CPU-bound –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ**, –æ—Å–æ–±–µ–Ω–Ω–æ —Å `ORDER BY` –∏ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

## –†–µ—à–µ–Ω–∏–µ: –ü–µ—Ä–µ–µ–∑–¥ –≤ –æ–±–ª–∞–∫–æ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã —Å –ª–æ–∫–∞–ª—å–Ω–æ–π.

### ‚úÖ –ü–ª–∞–Ω –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –æ–±–ª–∞–∫–æ

–¢—ã **–∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤**: –ø–æ—Ä–∞ –Ω–∞ –æ–±–ª–∞—á–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥.  
–õ—É—á—à–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É:

| –ú–∞—à–∏–Ω–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |
|--------|------------|---------------------------|
| **VM-1** | **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã**: FastAPI, Kafka, ClickHouse, ZooKeeper, Pyroscope | **8‚Äì16 vCPU, 32‚Äì64 GiB RAM, NVMe SSD 500+ GB** |
| **VM-2** | **–¢–æ–ª—å–∫–æ k6 (–Ω–∞–≥—Ä—É–∑–∫–∞)** | **4‚Äì8 vCPU, 16 GiB RAM** |

### –ü–æ—á–µ–º—É —Ç–∞–∫?

- **VM-1** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π workload (Kafka + ClickHouse ‚Äî –æ—á–µ–Ω—å —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã –∫ CPU –∏ –¥–∏—Å–∫—É),
- **VM-2** ‚Äî —Ç–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏, –Ω–µ –º–µ—à–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.


### –¢–µ—Å—Ç –∏ –∑–∞–º–µ—Ä—ã

–ü—Ä–æ–≤–µ–ª —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–º–µ—Ä –≤ –æ–±–ª–∞–∫–µ 
–ø–æ—Å–º–æ—Ç—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–∞–≥–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏

```bash
SELECT
    count() AS total,
    avg(dateDiff('second', ingest_time, store_time)) AS avg_e2e_sec,
    quantiles(0.5, 0.9, 0.95, 0.99)(dateDiff('second', ingest_time, store_time)) AS p_latencies_sec
FROM example.events
WHERE store_time IS NOT NULL

Query id: 217467a9-b372-4392-a7c8-c2b80a735533

‚îå‚îÄ‚îÄ‚îÄtotal‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄavg_e2e_sec‚îÄ‚î¨‚îÄp_latencies_sec‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3110400 ‚îÇ 606.0533516589506 ‚îÇ [602,922.9000000000005,979.4499999999998,1030.0900000000001] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.134 sec. Processed 3.11 million rows, 49.77 MB (23.27 million rows/s., 372.39 MB/s.)
Peak memory usage: 8.72 MiB.
```

–ù–æ —Ç–∞–∫ –∂–µ –≤–∏–∂—É —á—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –æ—á –º–Ω–æ–≥–æ 

```bash
SELECT sum(cnt) AS total_duplicate_rows
FROM
(
    SELECT count() AS cnt
    FROM example.events
    GROUP BY id
    HAVING cnt > 1
)

Query id: 4d64a561-c4c7-4c7a-bee8-dfe0d550d08d

‚îå‚îÄtotal_duplicate_rows‚îÄ‚îê
‚îÇ               633890 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 2.842 sec. Processed 3.11 million rows, 68.98 MB (1.09 million rows/s., 24.27 MB/s.)
Peak memory usage: 359.46 MiB.
``` 

```bash
SELECT
    count(),
    countDistinct(id)
FROM example.events

Query id: 2cba3b78-4b84-490b-8143-7217ac353a67

‚îå‚îÄcount()‚îÄ‚î¨‚îÄuniqExact(id)‚îÄ‚îê
‚îÇ 3110400 ‚îÇ       2793455 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 8.798 sec. Processed 3.11 million rows, 68.98 MB (353.52 thousand rows/s., 7.84 MB/s.)
Peak memory usage: 509.72 MiB.
```

> –†–ï–®–ï–ù–ò–ï –ø–æ –¥—É–±–ª–∏–∫–∞—Ç–∞–º:
> –≤ —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –¥–æ–±–∞–≤–∏–ª ORDER BY (id, store_time);  -- ‚Üê –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å store_time –≤ ORDER BY
> –î–æ —ç—Ç–æ–≥–æ –±—ã–ª ingest_time –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–µ –≤–µ—Ä–Ω–æ.


### –ù–æ–≤—ã–π —Ç–µ—Å—Ç –∏ –∑–∞–º–µ—Ä—ã 

**k6 —Ä–µ–∑—É–ª—å—Ç–∞—Ç**

```

         /\      Grafana   /‚Äæ‚Äæ/  
    /\  /  \     |\  __   /  /   
   /  \/    \    | |/ /  /   ‚Äæ‚Äæ\ 
  /          \   |   (  |  (‚Äæ)  |
 / __________ \  |_|\_\  \_____/ 

     execution: local
        script: /scripts/load-test.js
        output: -

     scenarios: (100.00%) 1 scenario, 3500 max VUs, 4m0s max duration (incl. graceful stop):
              * default: Up to 3500 looping VUs for 3m30s over 4 stages (gracefulRampDown: 30s, gracefulStop: 30s)



  ‚ñà THRESHOLDS 

    http_reqs
    ‚úì 'count>=3500' count=1952643


  ‚ñà TOTAL RESULTS 

    checks_total.......: 1952643 9282.361382/s
    checks_succeeded...: 100.00% 1952643 out of 1952643
    checks_failed......: 0.00%   0 out of 1952643

    ‚úì status equals 200

    HTTP
    http_req_duration..............: avg=206.81ms min=1.54ms med=195.78ms max=1.01s p(90)=366.77ms p(95)=418.58ms
      { expected_response:true }...: avg=206.81ms min=1.54ms med=195.78ms max=1.01s p(90)=366.77ms p(95)=418.58ms
    http_req_failed................: 0.00%   0 out of 1952643
    http_reqs......................: 1952643 9282.361382/s

    EXECUTION
    iteration_duration.............: avg=207.6ms  min=1.65ms med=196.4ms  max=1.67s p(90)=368.55ms p(95)=421.16ms
    iterations.....................: 1952643 9282.361382/s
    vus............................: 3494    min=18           max=3494
    vus_max........................: 3500    min=3500         max=3500

    NETWORK
    data_received..................: 281 MB  1.3 MB/s
    data_sent......................: 489 MB  2.3 MB/s




running (3m30.4s), 0000/3500 VUs, 1952643 complete and 0 interrupted iterations
default ‚úì [======================================] 0000/3500 VUs  3m30s
```


**–ü—Ä–æ–≤–µ—Ä–∫–∞ clickhouse**

```bash
SELECT
    count() AS total,
    avg(dateDiff('second', ingest_time, store_time)) AS avg_e2e_sec,
    quantiles(0.5, 0.9, 0.95, 0.99)(dateDiff('second', ingest_time, store_time)) AS p_latencies_sec
FROM example.events
WHERE store_time IS NOT NULL

Query id: 422f8251-7c55-44ba-b47f-4bfceb9b2469

‚îå‚îÄ‚îÄ‚îÄtotal‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄavg_e2e_sec‚îÄ‚î¨‚îÄp_latencies_sec‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1952643 ‚îÇ 475.4713155451355 ‚îÇ [476,765,821,852] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.123 sec. Processed 1.95 million rows, 31.24 MB (15.90 million rows/s., 254.35 MB/s.)
Peak memory usage: 5.29 MiB.

clickhouse-node1 :) SELECT
  min(ingest_time) AS first_event_sent,
  min(store_time) AS first_event_processed
FROM example.events;

SELECT
    min(ingest_time) AS first_event_sent,
    min(store_time) AS first_event_processed
FROM example.events

Query id: 4ea5e312-c344-40fe-9421-ea6f04045f7a

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄfirst_event_sent‚îÄ‚î¨‚îÄ‚îÄ‚îÄfirst_event_processed‚îÄ‚îê
‚îÇ 2025-12-24 09:43:54.121 ‚îÇ 2025-12-24 09:43:54.238 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.030 sec. Processed 1.95 million rows, 31.24 MB (64.13 million rows/s., 1.03 GB/s.)
Peak memory usage: 5.28 MiB.

clickhouse-node1 :) SELECT count(), count(DISTINCT id) FROM example.events;

SELECT
    count(),
    countDistinct(id)
FROM example.events

Query id: d738895d-a873-48bd-a251-fc3fbe1e2f96

‚îå‚îÄcount()‚îÄ‚î¨‚îÄuniqExact(id)‚îÄ‚îê
‚îÇ 1952643 ‚îÇ       1952643 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.370 sec. Processed 1.95 million rows, 43.43 MB (5.27 million rows/s., 117.28 MB/s.)
Peak memory usage: 240.35 MiB.

clickhouse-node1 :) SELECT sum(cnt) as total_duplicate_rows
FROM (
    SELECT count() as cnt
    FROM example.events
    GROUP BY id
    HAVING cnt > 1
)

SELECT sum(cnt) AS total_duplicate_rows
FROM
(
    SELECT count() AS cnt
    FROM example.events
    GROUP BY id
    HAVING cnt > 1
)

Query id: 9420634e-6c7b-4c50-8e56-4b6bdc30d745

‚îå‚îÄtotal_duplicate_rows‚îÄ‚îê
‚îÇ                    0 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1 row in set. Elapsed: 0.216 sec. Processed 1.95 million rows, 43.43 MB (9.05 million rows/s., 201.36 MB/s.)
Peak memory usage: 204.72 MiB.
```


## [SUMMARY](./ess_summary.md)
## [–ù–ê–ó–ê–î](./ess.md)