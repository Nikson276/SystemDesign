
# Встреча №1 - Ревью

## Нужно добавить и продумать

- [ ] Сервис `Subscription service` (для реализации SAGA Choreography на сценарие подписки) -> на развите, Переписываем на Orchestration и делаем SubscriptionWorkflowManager
- [ ] Сервис нотификации `Notification Service` на почту для подтверждения регистрации, отправки писем о покупке подписки, отмене подписки.
- [ ] Сервис `Auth Service` для авторизации, аутентификации и управления токенами
- [ ] Внешний OAuth Provider (Google/VK/Yandex...)
- [ ] Для сервиса Каталогов подумать про CQRS (Запись с индексацией отдельно, поиск отдельно. Обновление Read Model делается через event-driven подход)
- [ ] Сервис CDP для Эластика и Постгресс чтобы их засинкать
- [ ] Выбор CDN (сервис)
- [ ] Собственный CDN вместо Яндекса чтобы экономить деньги на услуге (выбирать сервер, выбирать оптимальный по расстоянию и загрузке)
- [ ] Доставка контента на CDN

### Сервис `Subscription service`

**SAGA Choreography на сценарие подписки**

- Payment Service → событие PaymentCompleted (или PaymentFailed)
- Subscription Service → ловит PaymentCompleted, обновляет базу, дергает Auth Service, публикует SubscriptionActivated.
- Notification Service → ловит SubscriptionActivated, шлет уведомление.
- Ads Service → ловит SubscriptionActivated или просто видит обновленный JWT.

Компенсация (если упал любой шаг):

- PaymentFailed → просто отмена процесса.
- Если упал Subscription Service — генерируется событие SubscriptionFailed, Payment Service ловит его и делает возврат.


## Почитать изучить

- [x] Почитать про OAuth20 - например через гугл, как работает вся цепочка, как получать инфо для профиля и т д
- [x] CQRS (изучить примеры и какие правила)
- [x] Теорема САР для Постгрес и для Эластик
  - [x] Postgres только Мастер=ACID, если реплики то из CAP по умолчанию = CP (жёсткая согласованность важнее, чем доступность при Partition)
  - [x] Elasticsearch — распределённая система по умолчанию (кластер из шардов и реплик), т.е. = AP (в момент Partition жертвует строгой согласованностью ради доступности). Согласованность eventual consistency.
- [x] Про CDP - что это и как реализовать для Эластик и\или Постгрес
- [ ] Выбор CDN сервера, на бэкенде или клиенте? мб новый сервер?
- [ ] Почитать про Пинг и как его использовать в поиске для анализа загрузки сервера
- [ ] Как доставлять контент на CDN (сначала они пустые)
- [x] Рекурентный платеж
- [x] Паттерн САГА спрятан (Изучить на этом примере и другом)

## На подумать и добавить или нет в архитектуру

- Подумать про микросервис Events для сбора статистики прослушивания клиента (отдельный сервис, в отдельном месте и сревере, хранилище)
- Clickhouse для большого объема статистики данных стукрутрированных (нужно протестить и проверить что это реально лучше Postgres)
- Подобные задачи как рекомендации, генерации ленты и т д это дорогие операции их надо отложенно выполнять, и выдавать резульатат. КАК?



## Конспект 

### CAP, ACID, BASE

| Система           | CAP-профиль | Философия | Что означает для работы                                                                                               |
| ----------------- | ----------- | --------- | --------------------------------------------------------------------------------------------------------------------- |
| **Postgres**      | **CP**      | **ACID**  | Жёсткая транзакционная модель. Согласованность ценой потери доступности записи при развале кластера.                  |
| **ElasticSearch** | **AP**      | **BASE**  | Всегда доступен для поиска, но новые данные могут появляться с задержкой. Реплики могут быть временно не согласованы. |

### CQRS

> **Command Query Responsibility Segregation (CQRS)** — это паттерн проектирования, который разделяет операции чтения и записи в базу данных.
> 
> - **Command** — это операция, которая изменяет состояние системы.  
    Пример: _"загрузить новый трек"_, _"обновить метаданные"_, _"удалить трек"_.
> - **Query** — это операция, которая читает данные, **не изменяя их**.  
    Пример: _"получить список треков по жанру"_, _"найти треки по названию"_.

> Когда CQRS не нужен
> 
> - Если система маленькая и БД справляется с чтением и записью в одной модели.
> - Если данные легко обрабатывать одинаково для чтения и записи.
> - Если задержка между записью и доступностью для чтения должна быть **нулевой** (CQRS часто асинхронен).


### CDC / CDP

Change Data Capture / Change Data Processing — это паттерн, который позволяет отслеживать изменения данных в источнике (insert/update/delete в Postgres) и передавать эти изменения в другие системы в реальном времени или почти в реальном времени

> **Пример использования:**
> 
> - Админ загружает трек → Write модель (Postgres) получает новую запись.
> - Система CDP замечает, что в таблице tracks добавились новые данные.
> - Событие отправляется в процессор (Kafka consumer).
> - Процессор обновляет Read модель — ElasticSearch индекс.
> - Пользователь через поиск уже может найти этот трек.

